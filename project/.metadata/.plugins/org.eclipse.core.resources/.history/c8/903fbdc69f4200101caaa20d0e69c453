/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2022 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>
#include <stdio.h>

#include "stm32f4xx.h"

#define THRESHOLD 2000

void GPIO_Init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;     // Enable GPIOA clock

    // PA5 as output (LED)
    GPIOA->MODER &= ~(3 << (5 * 2));         // Clear mode bits
    GPIOA->MODER |=  (1 << (5 * 2));         // Set as general output
}

void ADC_Init(void) {
    RCC->APB2ENR |= RCC_APB2ENR_ADC1EN;      // Enable ADC1 clock

    // Configure PA0 as analog (ADC input)
    GPIOA->MODER |= (3 << (0 * 2));          // Analog mode

    ADC1->CR2 = 0;                           // Clear CR2
    ADC1->SQR3 = 0;                          // Channel 0 (PA0)
    ADC1->SMPR2 |= (7 << 0);                 // Sample time for channel 0
    ADC1->CR2 |= ADC_CR2_ADON;              // Enable ADC1
}

uint16_t ADC_Read(void) {
    ADC1->CR2 |= ADC_CR2_SWSTART;           // Start conversion
    while (!(ADC1->SR & ADC_SR_EOC));       // Wait until conversion is done
    return ADC1->DR;                         // Return ADC value
}

void delay(volatile uint32_t time) {
    while (time--);
}

int main(void) {
    GPIO_Init();
    ADC_Init();

    while (1) {
        uint16_t value = ADC_Read();

        if (value < THRESHOLD) {
            GPIOA->ODR |= (1 << 5);          // LED ON
        } else {
            GPIOA->ODR &= ~(1 << 5);         // LED OFF
        }

        delay(100000);
    }
}

